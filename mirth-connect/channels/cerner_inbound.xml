<!--
  =============================================================================
  IHEP Platform - Cerner (Oracle Health) FHIR R4 Inbound Channel
  =============================================================================
  Receives FHIR R4 Bundles from Cerner/Oracle Health via HTTP POST.
  Handles Cerner-specific FHIR extensions, Millennium resource identifiers,
  and custom coding systems. Transforms incoming data using fhir_to_ihep.js
  and forwards normalized payloads to the IHEP integration gateway.

  Author: Jason M Jarmacz | Evolution Strategist | jason@ihep.app
  Co-Author: Claude by Anthropic
  =============================================================================
-->
<channel version="4.5.0">
  <id>a1b2c3d4-e5f6-7890-abcd-200000000002</id>
  <nextMetaDataId>3</nextMetaDataId>
  <name>IHEP_Cerner_FHIR_Inbound</name>
  <description>Receives FHIR R4 Bundles and individual Resources from Cerner (Oracle Health).
Handles Cerner-specific extensions, Millennium resource identifiers, and
custom coding systems. Normalizes data to IHEP format and forwards to
the integration gateway.</description>
  <revision>1</revision>
  <sourceConnector version="4.5.0">
    <metaDataId>0</metaDataId>
    <name>Cerner FHIR HTTP Listener</name>
    <properties class="com.mirth.connect.connectors.http.HttpReceiverProperties" version="4.5.0">
      <pluginProperties/>
      <listenerConnectorProperties version="4.5.0">
        <host>0.0.0.0</host>
        <port>8080</port>
      </listenerConnectorProperties>
      <sourceConnectorProperties version="4.5.0">
        <responseVariable>d1</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>false</processBatch>
        <firstResponse>false</firstResponse>
        <processingThreads>10</processingThreads>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
        <queueBufferSize>1000</queueBufferSize>
      </sourceConnectorProperties>
      <contextPath>/cerner/fhir</contextPath>
      <timeout>30000</timeout>
      <xmlBody>false</xmlBody>
      <parseMultipart>true</parseMultipart>
      <includeMetadata>true</includeMetadata>
      <binaryMimeTypes>application/pdf,image/*</binaryMimeTypes>
      <binaryMimeTypesRegex>false</binaryMimeTypesRegex>
      <responseContentType>application/fhir+json</responseContentType>
      <responseDataTypesId>JSON</responseDataTypesId>
      <responseStatusCode>200</responseStatusCode>
      <charset>UTF-8</charset>
      <staticResources/>
    </properties>
    <transformer version="4.5.0">
      <elements>
        <!-- Step 1: Validate incoming Cerner FHIR payload -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Validate Cerner FHIR Payload</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// Cerner (Oracle Health) FHIR R4 Payload Validation
// =============================================================================
// Validates the incoming request is a properly formed FHIR R4 resource
// or Bundle from Cerner/Oracle Health. Handles Cerner-specific headers
// and authentication tokens.
// =============================================================================

var payload = msg;
var contentType = sourceMap.get('Header').getField('Content-Type') || '';
var cernerTenantId = sourceMap.get('Header').getField('X-Cerner-Tenant-ID') || '';
var cernerClientId = sourceMap.get('Header').getField('X-Cerner-Client-ID') || '';

// Validate Content-Type
if (contentType.indexOf('application/fhir+json') === -1 &amp;&amp;
    contentType.indexOf('application/json') === -1) {
    logger.error('CERNER_INBOUND: Invalid Content-Type: ' + contentType);
    channelMap.put('responseStatusCode', '415');
    channelMap.put('responseBody', JSON.stringify({
        resourceType: 'OperationOutcome',
        issue: [{
            severity: 'error',
            code: 'invalid',
            diagnostics: 'Content-Type must be application/fhir+json or application/json'
        }]
    }));
    return;
}

// Parse and validate FHIR resource
var fhirData;
try {
    fhirData = JSON.parse(msg);
} catch (e) {
    logger.error('CERNER_INBOUND: Failed to parse JSON: ' + e.message);
    channelMap.put('responseStatusCode', '400');
    channelMap.put('responseBody', JSON.stringify({
        resourceType: 'OperationOutcome',
        issue: [{
            severity: 'error',
            code: 'invalid',
            diagnostics: 'Invalid JSON payload'
        }]
    }));
    return;
}

// Validate resourceType exists
if (!fhirData.resourceType) {
    logger.error('CERNER_INBOUND: Missing resourceType in FHIR payload');
    channelMap.put('responseStatusCode', '400');
    return;
}

// Cerner-specific: Extract Millennium identifiers if present
var millenniumIds = [];
if (fhirData.identifier &amp;&amp; Array.isArray(fhirData.identifier)) {
    for (var i = 0; i &lt; fhirData.identifier.length; i++) {
        var ident = fhirData.identifier[i];
        if (ident.system &amp;&amp; ident.system.indexOf('cerner.com') !== -1) {
            millenniumIds.push(ident.value);
        }
    }
}

// Track source metadata
channelMap.put('fhirResourceType', fhirData.resourceType);
channelMap.put('ehrVendor', 'cerner');
channelMap.put('cernerTenantId', cernerTenantId);
channelMap.put('cernerClientId', cernerClientId);
channelMap.put('millenniumIds', JSON.stringify(millenniumIds));
channelMap.put('receivedTimestamp', new Date().toISOString());
channelMap.put('fhirPayload', JSON.stringify(fhirData));

logger.info('CERNER_INBOUND: Received ' + fhirData.resourceType +
    ' from Cerner (Tenant: ' + cernerTenantId + ')');
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>

        <!-- Step 2: Handle Cerner-specific extensions -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Process Cerner Extensions</name>
          <sequenceNumber>1</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// Cerner-Specific Extension Processing
// =============================================================================
// Processes Cerner/Oracle Health proprietary FHIR extensions before
// the standard FHIR-to-IHEP transformation. Handles Millennium-specific
// coding systems, custom encounter classifications, and provider mappings.
// =============================================================================

var fhirData = JSON.parse(channelMap.get('fhirPayload'));
var cernerExtensions = {};

// Extract Cerner-specific extensions
if (fhirData.extension &amp;&amp; Array.isArray(fhirData.extension)) {
    for (var i = 0; i &lt; fhirData.extension.length; i++) {
        var ext = fhirData.extension[i];
        if (ext.url &amp;&amp; ext.url.indexOf('cerner.com') !== -1) {
            var extName = ext.url.split('/').pop();
            cernerExtensions[extName] = ext.valueString ||
                ext.valueCoding || ext.valueBoolean || ext.valueDateTime || null;
        }
    }
}

// Handle Cerner encounter classification codes
if (fhirData.resourceType === 'Encounter' &amp;&amp; fhirData.class) {
    var cernerClassMap = {
        'inpatient': 'IMP',
        'outpatient': 'AMB',
        'emergency': 'EMER',
        'observation': 'OBSENC'
    };
    if (fhirData.class.code &amp;&amp; cernerClassMap[fhirData.class.code.toLowerCase()]) {
        fhirData.class.code = cernerClassMap[fhirData.class.code.toLowerCase()];
    }
}

// Handle Cerner-specific coding system URIs
if (fhirData.code &amp;&amp; fhirData.code.coding) {
    for (var j = 0; j &lt; fhirData.code.coding.length; j++) {
        var coding = fhirData.code.coding[j];
        if (coding.system === 'https://fhir.cerner.com/code-system') {
            coding._cernerOriginalSystem = coding.system;
        }
    }
}

channelMap.put('cernerExtensions', JSON.stringify(cernerExtensions));
channelMap.put('fhirPayload', JSON.stringify(fhirData));

logger.info('CERNER_INBOUND: Processed ' +
    Object.keys(cernerExtensions).length + ' Cerner extensions');
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>

        <!-- Step 3: Transform FHIR to IHEP format -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Transform FHIR to IHEP Format</name>
          <sequenceNumber>2</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// FHIR to IHEP Transformation
// =============================================================================
var transformerPath = '/opt/connect/transformers/fhir_to_ihep.js';
var transformer = FileUtil.read(transformerPath);
eval(transformer);

var fhirPayload = JSON.parse(channelMap.get('fhirPayload'));

var ihepPayload = transformFhirToIhep(fhirPayload, {
    vendor: 'cerner',
    tenantId: channelMap.get('cernerTenantId'),
    clientId: channelMap.get('cernerClientId'),
    receivedAt: channelMap.get('receivedTimestamp'),
    channelName: 'IHEP_Cerner_FHIR_Inbound',
    vendorExtensions: JSON.parse(channelMap.get('cernerExtensions')),
    millenniumIds: JSON.parse(channelMap.get('millenniumIds'))
});

if (ihepPayload &amp;&amp; ihepPayload.success) {
    channelMap.put('ihepPayload', JSON.stringify(ihepPayload.data));
    channelMap.put('resourceCount', ihepPayload.resourceCount || 1);
    logger.info('CERNER_INBOUND: Transformed ' + ihepPayload.resourceCount +
        ' resource(s) to IHEP format');
} else {
    var errorMsg = ihepPayload ? ihepPayload.error : 'Transformation returned null';
    logger.error('CERNER_INBOUND: Transformation failed: ' + errorMsg);
    channelMap.put('transformError', errorMsg);
}
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundDataType>RAW</inboundDataType>
      <outboundDataType>RAW</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
    </transformer>
    <filter version="4.5.0">
      <elements>
        <com.mirth.connect.plugins.javascriptrule.JavaScriptRule version="4.5.0">
          <name>Filter Invalid Payloads</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
return channelMap.get('ihepPayload') != null &amp;&amp; channelMap.get('transformError') == null;
          </script>
        </com.mirth.connect.plugins.javascriptrule.JavaScriptRule>
      </elements>
    </filter>
  </sourceConnector>

  <destinationConnectors>
    <!-- Destination 1: Forward to IHEP Integration Gateway -->
    <connector version="4.5.0">
      <metaDataId>1</metaDataId>
      <name>IHEP Integration Gateway</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>30000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>3</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>5</threadCount>
          <threadAssignmentVariable/>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/inbound</host>
        <useProxyServer>false</useProxyServer>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
          <entry>
            <string>X-IHEP-Source</string>
            <string>mirth-connect</string>
          </entry>
          <entry>
            <string>X-IHEP-Vendor</string>
            <string>cerner</string>
          </entry>
          <entry>
            <string>X-IHEP-Channel</string>
            <string>IHEP_Cerner_FHIR_Inbound</string>
          </entry>
          <entry>
            <string>X-IHEP-Timestamp</string>
            <string>${receivedTimestamp}</string>
          </entry>
        </headers>
        <parameters class="linked-hash-map"/>
        <useHeadersVariable>false</useHeadersVariable>
        <useParametersVariable>false</useParametersVariable>
        <responseXmlBody>false</responseXmlBody>
        <responseParseMultipart>true</responseParseMultipart>
        <responseIncludeMetadata>false</responseIncludeMetadata>
        <responseBinaryMimeTypes>application/pdf,image/*</responseBinaryMimeTypes>
        <responseBinaryMimeTypesRegex>false</responseBinaryMimeTypesRegex>
        <multipart>false</multipart>
        <socketTimeout>60000</socketTimeout>
        <connectTimeout>10000</connectTimeout>
        <charset>UTF-8</charset>
        <content>${ihepPayload}</content>
        <contentType>application/json</contentType>
        <dataTypeBinary>false</dataTypeBinary>
        <authentication>false</authentication>
      </properties>
      <transformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </transformer>
      <responseTransformer version="4.5.0">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
            <name>Process Gateway Response</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>
var statusCode = $('responseStatusLine');
var responseBody = $('responsePayload');
logger.info('CERNER_INBOUND: Gateway responded with status ' + statusCode);
if (statusCode &amp;&amp; statusCode.indexOf('200') === -1 &amp;&amp; statusCode.indexOf('201') === -1) {
    logger.warn('CERNER_INBOUND: Non-success response from gateway: ' + responseBody);
}
            </script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </responseTransformer>
      <filter version="4.5.0">
        <elements/>
      </filter>
      <waitForPrevious>true</waitForPrevious>
    </connector>

    <!-- Destination 2: Audit Log -->
    <connector version="4.5.0">
      <metaDataId>2</metaDataId>
      <name>Audit Logger</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>2</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>2</threadCount>
          <threadAssignmentVariable/>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>false</reattachAttachments>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/audit</host>
        <useProxyServer>false</useProxyServer>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
        </headers>
        <parameters class="linked-hash-map"/>
        <useHeadersVariable>false</useHeadersVariable>
        <useParametersVariable>false</useParametersVariable>
        <responseXmlBody>false</responseXmlBody>
        <responseParseMultipart>false</responseParseMultipart>
        <responseIncludeMetadata>false</responseIncludeMetadata>
        <multipart>false</multipart>
        <socketTimeout>15000</socketTimeout>
        <connectTimeout>5000</connectTimeout>
        <charset>UTF-8</charset>
        <content>{
  "event": "ehr_data_received",
  "vendor": "cerner",
  "channel": "IHEP_Cerner_FHIR_Inbound",
  "resourceType": "${fhirResourceType}",
  "resourceCount": ${resourceCount},
  "timestamp": "${receivedTimestamp}",
  "cernerTenantId": "${cernerTenantId}"
}</content>
        <contentType>application/json</contentType>
        <dataTypeBinary>false</dataTypeBinary>
        <authentication>false</authentication>
      </properties>
      <transformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </transformer>
      <responseTransformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </responseTransformer>
      <filter version="4.5.0">
        <elements/>
      </filter>
      <waitForPrevious>false</waitForPrevious>
    </connector>
  </destinationConnectors>

  <preprocessingScript>// Cerner Inbound Preprocessing
logger.debug('CERNER_INBOUND: Raw message received, length: ' + message.length);
return message;</preprocessingScript>

  <postprocessingScript>// Cerner Inbound Postprocessing
logger.info('CERNER_INBOUND: Message processing complete for ' +
    channelMap.get('fhirResourceType') + ' resource');
return;</postprocessingScript>

  <deployScript>// Cerner Inbound Deploy Script
logger.info('IHEP Cerner FHIR Inbound channel deployed successfully');
logger.info('Listening on /cerner/fhir for FHIR R4 resources');
return;</deployScript>

  <undeployScript>// Cerner Inbound Undeploy Script
logger.info('IHEP Cerner FHIR Inbound channel undeployed');
return;</undeployScript>

  <properties version="4.5.0">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>PRODUCTION</messageStorageMode>
    <encryptData>true</encryptData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>true</storeAttachments>
    <tags>
      <tag>cerner</tag>
      <tag>oracle-health</tag>
      <tag>fhir</tag>
      <tag>inbound</tag>
      <tag>ihep</tag>
    </tags>
    <metaDataColumns/>
    <attachmentProperties version="4.5.0">
      <type>None</type>
      <properties/>
    </attachmentProperties>
    <resourceIds class="linked-hash-map">
      <entry>
        <string>Default Resource</string>
        <string>[Default Resource]</string>
      </entry>
    </resourceIds>
  </properties>
</channel>
