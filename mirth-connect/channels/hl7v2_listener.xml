<!--
  =============================================================================
  IHEP Platform - HL7 v2.x TCP Listener Channel
  =============================================================================
  Receives HL7 v2.x messages via TCP/MLLP (Minimal Lower Layer Protocol).
  Supports ADT (Admit/Discharge/Transfer), ORU (Observation Results), and
  SIU (Scheduling Information Unsolicited) message types. Converts HL7 v2.x
  to FHIR R4 using hl7v2_to_fhir.js transformer, then forwards to the
  IHEP integration gateway. Generates proper ACK/NAK responses.

  Author: Jason M Jarmacz | Evolution Strategist | jason@ihep.app
  Co-Author: Claude by Anthropic
  =============================================================================
-->
<channel version="4.5.0">
  <id>a1b2c3d4-e5f6-7890-abcd-500000000005</id>
  <nextMetaDataId>3</nextMetaDataId>
  <name>IHEP_HL7v2_TCP_Listener</name>
  <description>Receives HL7 v2.x messages via TCP/MLLP on port 6661.
Supports ADT (A01-A08, A28, A31, A40), ORU (R01), and SIU (S12-S17, S26) message types.
Converts messages to FHIR R4 using hl7v2_to_fhir.js, then normalizes to IHEP
format and forwards to the integration gateway. Generates HL7 ACK responses.</description>
  <revision>1</revision>
  <sourceConnector version="4.5.0">
    <metaDataId>0</metaDataId>
    <name>HL7 v2.x TCP/MLLP Listener</name>
    <properties class="com.mirth.connect.connectors.tcp.TcpReceiverProperties" version="4.5.0">
      <pluginProperties>
        <com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties version="4.5.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.5.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>true</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.5.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.5.0">
            <splitType>MSH_Segment</splitType>
            <batchScript/>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.5.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage/>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
        </com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties>
      </pluginProperties>
      <listenerConnectorProperties version="4.5.0">
        <host>0.0.0.0</host>
        <port>6661</port>
      </listenerConnectorProperties>
      <sourceConnectorProperties version="4.5.0">
        <responseVariable>Auto-generate (After source transformer)</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>true</processBatch>
        <firstResponse>false</firstResponse>
        <processingThreads>5</processingThreads>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
        <queueBufferSize>1000</queueBufferSize>
      </sourceConnectorProperties>
      <!-- MLLP / LLP Framing Configuration -->
      <transmissionModeProperties class="com.mirth.connect.plugins.mllpmode.MLLPModeProperties" version="4.5.0">
        <pluginPointName>MLLP</pluginPointName>
        <startOfMessageBytes>0B</startOfMessageBytes>
        <endOfMessageBytes>1C0D</endOfMessageBytes>
        <useMLLPv2>false</useMLLPv2>
        <ackBytes/>
        <nackBytes/>
        <maxRetries>0</maxRetries>
      </transmissionModeProperties>
      <serverMode>true</serverMode>
      <reconnectInterval>5000</reconnectInterval>
      <receiveTimeout>0</receiveTimeout>
      <bufferSize>65536</bufferSize>
      <maxConnections>10</maxConnections>
      <keepConnectionOpen>true</keepConnectionOpen>
      <dataTypeBinary>false</dataTypeBinary>
      <charsetEncoding>UTF-8</charsetEncoding>
      <respondOnNewConnection>0</respondOnNewConnection>
    </properties>
    <transformer version="4.5.0">
      <elements>
        <!-- Step 1: Parse HL7 v2.x message and extract metadata -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Parse HL7 v2.x Message</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// HL7 v2.x Message Parsing and Validation
// =============================================================================
// Extracts key metadata from the HL7 v2.x message header (MSH) segment
// and validates the message type is supported.
// =============================================================================

// Extract MSH segment fields (Mirth auto-parses HL7 into XML)
var msgType = msg['MSH']['MSH.9']['MSH.9.1'].toString();
var triggerEvent = msg['MSH']['MSH.9']['MSH.9.2'].toString();
var sendingApp = msg['MSH']['MSH.3']['MSH.3.1'].toString();
var sendingFacility = msg['MSH']['MSH.4']['MSH.4.1'].toString();
var receivingApp = msg['MSH']['MSH.5']['MSH.5.1'].toString();
var messageControlId = msg['MSH']['MSH.10'].toString();
var hl7Version = msg['MSH']['MSH.12']['MSH.12.1'].toString();

// Validate supported message types
var supportedTypes = {
    'ADT': ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08', 'A28', 'A31', 'A40'],
    'ORU': ['R01'],
    'SIU': ['S12', 'S13', 'S14', 'S15', 'S16', 'S17', 'S26']
};

var isSupported = false;
if (supportedTypes[msgType] &amp;&amp; supportedTypes[msgType].indexOf(triggerEvent) !== -1) {
    isSupported = true;
}

if (!isSupported) {
    logger.warn('HL7V2_LISTENER: Unsupported message type: ' + msgType + '^' + triggerEvent);
}

// Store metadata for downstream processing
channelMap.put('hl7MessageType', msgType);
channelMap.put('hl7TriggerEvent', triggerEvent);
channelMap.put('hl7FullType', msgType + '_' + triggerEvent);
channelMap.put('sendingApplication', sendingApp);
channelMap.put('sendingFacility', sendingFacility);
channelMap.put('messageControlId', messageControlId);
channelMap.put('hl7Version', hl7Version);
channelMap.put('isSupported', isSupported);
channelMap.put('receivedTimestamp', new Date().toISOString());

// Extract patient identifier from PID segment if present
try {
    var patientId = msg['PID']['PID.3']['PID.3.1'].toString();
    var patientIdAuthority = msg['PID']['PID.3']['PID.3.4'].toString();
    channelMap.put('patientId', patientId);
    channelMap.put('patientIdAuthority', patientIdAuthority);
} catch (e) {
    channelMap.put('patientId', 'unknown');
    channelMap.put('patientIdAuthority', 'unknown');
}

logger.info('HL7V2_LISTENER: Received ' + msgType + '^' + triggerEvent +
    ' from ' + sendingApp + '@' + sendingFacility +
    ' (Control ID: ' + messageControlId + ')');
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>

        <!-- Step 2: Convert HL7 v2.x to FHIR R4 -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Convert HL7 v2.x to FHIR R4</name>
          <sequenceNumber>1</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// HL7 v2.x to FHIR R4 Conversion
// =============================================================================
// Loads and executes the hl7v2_to_fhir.js transformer to convert the
// HL7 v2.x message into FHIR R4 resources based on message type.
// =============================================================================

var transformerPath = '/opt/connect/transformers/hl7v2_to_fhir.js';
var transformer = FileUtil.read(transformerPath);
eval(transformer);

// Execute HL7 v2.x to FHIR conversion
var fhirResult = convertHl7v2ToFhir(msg, {
    messageType: channelMap.get('hl7MessageType'),
    triggerEvent: channelMap.get('hl7TriggerEvent'),
    sendingApplication: channelMap.get('sendingApplication'),
    sendingFacility: channelMap.get('sendingFacility'),
    messageControlId: channelMap.get('messageControlId'),
    hl7Version: channelMap.get('hl7Version')
});

if (fhirResult &amp;&amp; fhirResult.success) {
    channelMap.put('fhirBundle', JSON.stringify(fhirResult.bundle));
    channelMap.put('fhirResourceCount', fhirResult.resourceCount || 0);
    logger.info('HL7V2_LISTENER: Converted to FHIR Bundle with ' +
        fhirResult.resourceCount + ' resource(s)');
} else {
    var errorMsg = fhirResult ? fhirResult.error : 'Conversion returned null';
    logger.error('HL7V2_LISTENER: HL7-to-FHIR conversion failed: ' + errorMsg);
    channelMap.put('conversionError', errorMsg);
}
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>

        <!-- Step 3: Transform FHIR to IHEP format -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Transform FHIR to IHEP Format</name>
          <sequenceNumber>2</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// FHIR to IHEP Transformation
// =============================================================================
if (channelMap.get('conversionError') != null) {
    logger.warn('HL7V2_LISTENER: Skipping IHEP transform due to conversion error');
    return;
}

var fhirTransformerPath = '/opt/connect/transformers/fhir_to_ihep.js';
var fhirTransformer = FileUtil.read(fhirTransformerPath);
eval(fhirTransformer);

var fhirBundle = JSON.parse(channelMap.get('fhirBundle'));

var ihepPayload = transformFhirToIhep(fhirBundle, {
    vendor: 'hl7v2',
    sourceApplication: channelMap.get('sendingApplication'),
    sourceFacility: channelMap.get('sendingFacility'),
    originalMessageType: channelMap.get('hl7FullType'),
    receivedAt: channelMap.get('receivedTimestamp'),
    channelName: 'IHEP_HL7v2_TCP_Listener'
});

if (ihepPayload &amp;&amp; ihepPayload.success) {
    channelMap.put('ihepPayload', JSON.stringify(ihepPayload.data));
    channelMap.put('resourceCount', ihepPayload.resourceCount || 1);
    logger.info('HL7V2_LISTENER: Transformed to IHEP format with ' +
        ihepPayload.resourceCount + ' resource(s)');
} else {
    var errorMsg = ihepPayload ? ihepPayload.error : 'Transformation returned null';
    logger.error('HL7V2_LISTENER: FHIR-to-IHEP transformation failed: ' + errorMsg);
    channelMap.put('transformError', errorMsg);
}
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundDataType>HL7V2</inboundDataType>
      <outboundDataType>RAW</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.5.0">
        <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.5.0">
          <handleRepetitions>true</handleRepetitions>
          <handleSubcomponents>true</handleSubcomponents>
          <useStrictParser>false</useStrictParser>
          <useStrictValidation>false</useStrictValidation>
          <stripNamespaces>true</stripNamespaces>
          <segmentDelimiter>\r</segmentDelimiter>
          <convertLineBreaks>true</convertLineBreaks>
        </serializationProperties>
      </inboundProperties>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
    </transformer>
    <filter version="4.5.0">
      <elements>
        <com.mirth.connect.plugins.javascriptrule.JavaScriptRule version="4.5.0">
          <name>Filter Unsupported and Failed Messages</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
// Allow through only supported, successfully transformed messages
return channelMap.get('isSupported') === true &amp;&amp;
       channelMap.get('ihepPayload') != null &amp;&amp;
       channelMap.get('transformError') == null &amp;&amp;
       channelMap.get('conversionError') == null;
          </script>
        </com.mirth.connect.plugins.javascriptrule.JavaScriptRule>
      </elements>
    </filter>
  </sourceConnector>

  <destinationConnectors>
    <!-- Destination 1: Forward to IHEP Integration Gateway -->
    <connector version="4.5.0">
      <metaDataId>1</metaDataId>
      <name>IHEP Integration Gateway</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>30000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>3</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>5</threadCount>
          <threadAssignmentVariable/>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/inbound</host>
        <useProxyServer>false</useProxyServer>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
          <entry>
            <string>X-IHEP-Source</string>
            <string>mirth-connect</string>
          </entry>
          <entry>
            <string>X-IHEP-Vendor</string>
            <string>hl7v2</string>
          </entry>
          <entry>
            <string>X-IHEP-Channel</string>
            <string>IHEP_HL7v2_TCP_Listener</string>
          </entry>
          <entry>
            <string>X-IHEP-Message-Type</string>
            <string>${hl7FullType}</string>
          </entry>
          <entry>
            <string>X-IHEP-Timestamp</string>
            <string>${receivedTimestamp}</string>
          </entry>
        </headers>
        <parameters class="linked-hash-map"/>
        <useHeadersVariable>false</useHeadersVariable>
        <useParametersVariable>false</useParametersVariable>
        <responseXmlBody>false</responseXmlBody>
        <responseParseMultipart>true</responseParseMultipart>
        <responseIncludeMetadata>false</responseIncludeMetadata>
        <multipart>false</multipart>
        <socketTimeout>60000</socketTimeout>
        <connectTimeout>10000</connectTimeout>
        <charset>UTF-8</charset>
        <content>${ihepPayload}</content>
        <contentType>application/json</contentType>
        <dataTypeBinary>false</dataTypeBinary>
        <authentication>false</authentication>
      </properties>
      <transformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </transformer>
      <responseTransformer version="4.5.0">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
            <name>Process Gateway Response</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>
var statusCode = $('responseStatusLine');
logger.info('HL7V2_LISTENER: Gateway responded with status ' + statusCode);
if (statusCode &amp;&amp; statusCode.indexOf('200') === -1 &amp;&amp; statusCode.indexOf('201') === -1) {
    logger.warn('HL7V2_LISTENER: Non-success response: ' + $('responsePayload'));
}
            </script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </responseTransformer>
      <filter version="4.5.0">
        <elements/>
      </filter>
      <waitForPrevious>true</waitForPrevious>
    </connector>

    <!-- Destination 2: Audit Log -->
    <connector version="4.5.0">
      <metaDataId>2</metaDataId>
      <name>Audit Logger</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>2</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>2</threadCount>
          <threadAssignmentVariable/>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>false</reattachAttachments>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/audit</host>
        <useProxyServer>false</useProxyServer>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
        </headers>
        <parameters class="linked-hash-map"/>
        <useHeadersVariable>false</useHeadersVariable>
        <useParametersVariable>false</useParametersVariable>
        <responseXmlBody>false</responseXmlBody>
        <responseParseMultipart>false</responseParseMultipart>
        <responseIncludeMetadata>false</responseIncludeMetadata>
        <multipart>false</multipart>
        <socketTimeout>15000</socketTimeout>
        <connectTimeout>5000</connectTimeout>
        <charset>UTF-8</charset>
        <content>{
  "event": "hl7v2_message_received",
  "vendor": "hl7v2",
  "channel": "IHEP_HL7v2_TCP_Listener",
  "messageType": "${hl7FullType}",
  "sendingApplication": "${sendingApplication}",
  "sendingFacility": "${sendingFacility}",
  "messageControlId": "${messageControlId}",
  "patientId": "${patientId}",
  "resourceCount": ${resourceCount},
  "timestamp": "${receivedTimestamp}"
}</content>
        <contentType>application/json</contentType>
        <dataTypeBinary>false</dataTypeBinary>
        <authentication>false</authentication>
      </properties>
      <transformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </transformer>
      <responseTransformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </responseTransformer>
      <filter version="4.5.0">
        <elements/>
      </filter>
      <waitForPrevious>false</waitForPrevious>
    </connector>
  </destinationConnectors>

  <preprocessingScript>// HL7 v2.x TCP Listener Preprocessing
logger.debug('HL7V2_LISTENER: Raw HL7 message received');
return message;</preprocessingScript>

  <postprocessingScript>// HL7 v2.x TCP Listener Postprocessing
logger.info('HL7V2_LISTENER: Message processing complete for ' +
    channelMap.get('hl7FullType') + ' from ' +
    channelMap.get('sendingFacility'));
return;</postprocessingScript>

  <deployScript>// HL7 v2.x TCP Listener Deploy Script
logger.info('IHEP HL7 v2.x TCP Listener channel deployed successfully');
logger.info('Listening on port 6661 for HL7 v2.x MLLP connections');
logger.info('Supported message types: ADT, ORU, SIU');
return;</deployScript>

  <undeployScript>// HL7 v2.x TCP Listener Undeploy Script
logger.info('IHEP HL7 v2.x TCP Listener channel undeployed');
return;</undeployScript>

  <properties version="4.5.0">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>PRODUCTION</messageStorageMode>
    <encryptData>true</encryptData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>true</storeAttachments>
    <tags>
      <tag>hl7v2</tag>
      <tag>tcp</tag>
      <tag>mllp</tag>
      <tag>inbound</tag>
      <tag>ihep</tag>
    </tags>
    <metaDataColumns/>
    <attachmentProperties version="4.5.0">
      <type>None</type>
      <properties/>
    </attachmentProperties>
    <resourceIds class="linked-hash-map">
      <entry>
        <string>Default Resource</string>
        <string>[Default Resource]</string>
      </entry>
    </resourceIds>
  </properties>
</channel>
