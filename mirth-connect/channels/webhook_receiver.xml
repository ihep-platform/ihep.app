<?xml version="1.0" encoding="UTF-8"?>
<!--
  EHR Webhook Receiver Channel
  Receives real-time event notifications from EHR systems.
  Validates signatures, routes by event type.

  Author: Jason M Jarmacz | Co-Author: Claude by Anthropic
-->
<channel version="4.5.0">
  <id>webhook-receiver-006</id>
  <nextMetaDataId>2</nextMetaDataId>
  <name>EHR Webhook Receiver</name>
  <description>Receives real-time webhook events from EHR systems.
Validates webhook signatures (HMAC-SHA256), routes events by type
(ADT, ORU, SIU) to the IHEP integration gateway for processing.</description>
  <revision>1</revision>
  <enabled>true</enabled>

  <sourceConnector version="4.5.0">
    <metaDataId>0</metaDataId>
    <name>Webhook HTTP Listener</name>
    <properties class="com.mirth.connect.connectors.http.HttpReceiverProperties" version="4.5.0">
      <pluginProperties/>
      <listenerConnectorProperties version="4.5.0">
        <host>0.0.0.0</host>
        <port>8080</port>
      </listenerConnectorProperties>
      <sourceConnectorProperties version="4.5.0">
        <responseVariable>d1</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>false</processBatch>
        <processingThreads>8</processingThreads>
        <queueBufferSize>2000</queueBufferSize>
      </sourceConnectorProperties>
      <contextPath>/webhooks/ehr</contextPath>
      <timeout>15000</timeout>
      <xmlBody>false</xmlBody>
      <parseMultipart>false</parseMultipart>
      <includeMetadata>true</includeMetadata>
      <responseContentType>application/json</responseContentType>
      <responseStatusCode>200</responseStatusCode>
      <charset>UTF-8</charset>
    </properties>
    <transformer version="4.5.0">
      <elements>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Validate and Route Webhook</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
var rawMsg = connectorMessage.getRawData();
var webhookPayload = JSON.parse(rawMsg);

// Extract webhook metadata from headers
var signature = sourceMap.get('X-Webhook-Signature') || '';
var vendor = sourceMap.get('X-EHR-Vendor') || webhookPayload.vendor || 'unknown';
var eventType = webhookPayload.event_type || webhookPayload.eventType || 'unknown';

channelMap.put('ehr_vendor', vendor);
channelMap.put('event_type', eventType);
channelMap.put('webhook_signature', signature);
channelMap.put('received_at', new Date().toISOString());

// Validate webhook signature if present
if (signature) {
    var javax = java.lang.Class.forName('javax.crypto.Mac');
    // Signature validation delegated to integration gateway
    // which has access to per-partner secrets
    channelMap.put('signature_validated', 'pending');
} else {
    channelMap.put('signature_validated', 'none');
}

// Classify event for routing
var eventCategory = 'other';
if (eventType.indexOf('ADT') !== -1 || eventType.indexOf('admit') !== -1 ||
    eventType.indexOf('discharge') !== -1 || eventType.indexOf('transfer') !== -1) {
    eventCategory = 'adt';
} else if (eventType.indexOf('ORU') !== -1 || eventType.indexOf('result') !== -1 ||
           eventType.indexOf('observation') !== -1) {
    eventCategory = 'oru';
} else if (eventType.indexOf('SIU') !== -1 || eventType.indexOf('schedule') !== -1 ||
           eventType.indexOf('appointment') !== -1) {
    eventCategory = 'siu';
}
channelMap.put('event_category', eventCategory);

// Wrap in IHEP envelope
var envelope = {
    ihep_version: '1.0',
    source: 'webhook',
    vendor: vendor,
    event_type: eventType,
    event_category: eventCategory,
    received_at: channelMap.get('received_at'),
    signature: signature,
    payload: webhookPayload
};

tmp = JSON.stringify(envelope);

logger.info('Webhook received: ' + eventType + ' from ' + vendor);
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundDataType>RAW</inboundDataType>
      <outboundDataType>RAW</outboundDataType>
    </transformer>
    <filter version="4.5.0"><elements/></filter>
  </sourceConnector>

  <destinationConnectors>
    <connector version="4.5.0">
      <metaDataId>1</metaDataId>
      <name>IHEP Webhook Handler</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>5000</retryIntervalMillis>
          <retryCount>5</retryCount>
          <threadCount>4</threadCount>
          <queueBufferSize>2000</queueBufferSize>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/webhooks</host>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry><string>Content-Type</string><string>application/json</string></entry>
          <entry><string>X-EHR-Vendor</string><string>${ehr_vendor}</string></entry>
          <entry><string>X-Event-Type</string><string>${event_type}</string></entry>
          <entry><string>X-Event-Category</string><string>${event_category}</string></entry>
          <entry><string>X-Webhook-Signature</string><string>${webhook_signature}</string></entry>
          <entry><string>X-Channel-Id</string><string>webhook-receiver-006</string></entry>
        </headers>
        <content>${message.encodedData}</content>
        <contentType>application/json</contentType>
        <socketTimeout>15000</socketTimeout>
        <charset>UTF-8</charset>
      </properties>
      <transformer version="4.5.0"><elements/><inboundDataType>RAW</inboundDataType><outboundDataType>RAW</outboundDataType></transformer>
      <filter version="4.5.0"><elements/></filter>
    </connector>
  </destinationConnectors>

  <preprocessingScript>return message;</preprocessingScript>
  <postprocessingScript>return;</postprocessingScript>
  <deployScript>logger.info('EHR Webhook Receiver channel deployed');</deployScript>

  <properties version="4.5.0">
    <messageStorageMode>PRODUCTION</messageStorageMode>
    <encryptData>true</encryptData>
    <initialState>STARTED</initialState>
    <tags class="linked-hash-set">
      <string>EHR</string><string>Webhook</string><string>Realtime</string>
    </tags>
  </properties>
</channel>
