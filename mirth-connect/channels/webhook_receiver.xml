<!--
  =============================================================================
  IHEP Platform - EHR Webhook Receiver Channel
  =============================================================================
  Receives real-time webhook event notifications from EHR systems.
  Validates webhook signatures (HMAC-SHA256), classifies events by type,
  and routes to the IHEP integration gateway webhook endpoint.

  Supports webhook formats from Epic, Cerner, Allscripts, athenahealth,
  and generic SMART on FHIR subscription notifications.

  Author: Jason M Jarmacz | Evolution Strategist | jason@ihep.app
  Co-Author: Claude by Anthropic
  =============================================================================
-->
<channel version="4.5.0">
  <id>a1b2c3d4-e5f6-7890-abcd-600000000006</id>
  <nextMetaDataId>3</nextMetaDataId>
  <name>IHEP_Webhook_Receiver</name>
  <description>Receives real-time webhook notifications from EHR systems.
Validates HMAC-SHA256 signatures, classifies events (ADT, clinical, scheduling,
workflow), and routes to the IHEP integration gateway for processing.
Supports Epic, Cerner, Allscripts, athenahealth, and SMART on FHIR webhooks.</description>
  <revision>1</revision>
  <sourceConnector version="4.5.0">
    <metaDataId>0</metaDataId>
    <name>Webhook HTTP Listener</name>
    <properties class="com.mirth.connect.connectors.http.HttpReceiverProperties" version="4.5.0">
      <pluginProperties/>
      <listenerConnectorProperties version="4.5.0">
        <host>0.0.0.0</host>
        <port>8080</port>
      </listenerConnectorProperties>
      <sourceConnectorProperties version="4.5.0">
        <responseVariable>d1</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>false</processBatch>
        <firstResponse>false</firstResponse>
        <processingThreads>10</processingThreads>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
        <queueBufferSize>2000</queueBufferSize>
      </sourceConnectorProperties>
      <contextPath>/webhooks/ehr</contextPath>
      <timeout>15000</timeout>
      <xmlBody>false</xmlBody>
      <parseMultipart>false</parseMultipart>
      <includeMetadata>true</includeMetadata>
      <binaryMimeTypes>application/pdf,image/*</binaryMimeTypes>
      <binaryMimeTypesRegex>false</binaryMimeTypesRegex>
      <responseContentType>application/json</responseContentType>
      <responseDataTypesId>JSON</responseDataTypesId>
      <responseStatusCode>200</responseStatusCode>
      <charset>UTF-8</charset>
      <staticResources/>
    </properties>
    <transformer version="4.5.0">
      <elements>
        <!-- Step 1: Validate webhook signature and parse payload -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Validate Webhook Signature</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// Webhook Signature Validation and Payload Parsing
// =============================================================================
// Validates incoming webhook signatures using HMAC-SHA256.
// Supports multiple vendor signature header formats.
// Parses and classifies the webhook event for routing.
// =============================================================================

var rawPayload = msg;
var headers = sourceMap.get('Header');
var httpMethod = sourceMap.get('Method') || 'POST';

// Extract signature from various vendor header formats
var signature = headers.getField('X-Webhook-Signature') ||
    headers.getField('X-Hub-Signature-256') ||
    headers.getField('X-Epic-Signature') ||
    headers.getField('X-Cerner-Signature') ||
    headers.getField('X-Athena-Signature') || '';

// Detect vendor from headers or payload
var vendor = headers.getField('X-EHR-Vendor') ||
    headers.getField('X-Webhook-Source') || '';
var webhookId = headers.getField('X-Webhook-ID') ||
    headers.getField('X-Request-ID') || '';
var deliveryId = headers.getField('X-Webhook-Delivery') || '';

// Parse the webhook payload
var webhookPayload;
try {
    webhookPayload = JSON.parse(rawPayload);
} catch (e) {
    logger.error('WEBHOOK_RECEIVER: Failed to parse webhook JSON: ' + e.message);
    channelMap.put('responseStatusCode', '400');
    channelMap.put('responseBody', JSON.stringify({
        status: 'error',
        message: 'Invalid JSON payload'
    }));
    return;
}

// Auto-detect vendor from payload if not in headers
if (!vendor) {
    if (webhookPayload.vendor) vendor = webhookPayload.vendor;
    else if (webhookPayload.source &amp;&amp; webhookPayload.source.indexOf('epic') !== -1) vendor = 'epic';
    else if (webhookPayload.source &amp;&amp; webhookPayload.source.indexOf('cerner') !== -1) vendor = 'cerner';
    else if (webhookPayload.source &amp;&amp; webhookPayload.source.indexOf('athena') !== -1) vendor = 'athenahealth';
    else if (webhookPayload.source &amp;&amp; webhookPayload.source.indexOf('allscripts') !== -1) vendor = 'allscripts';
    else vendor = 'unknown';
}

// Validate signature integrity
// Note: Full HMAC validation is delegated to the integration gateway
// which has access to per-vendor webhook secrets
var signatureStatus = 'none';
if (signature) {
    signatureStatus = 'present_pending_verification';
    logger.info('WEBHOOK_RECEIVER: Signature present, will forward for verification');
} else {
    logger.warn('WEBHOOK_RECEIVER: No webhook signature present from ' + vendor);
    signatureStatus = 'absent';
}

// Store metadata
channelMap.put('webhookVendor', vendor);
channelMap.put('webhookSignature', signature);
channelMap.put('webhookId', webhookId);
channelMap.put('deliveryId', deliveryId);
channelMap.put('signatureStatus', signatureStatus);
channelMap.put('receivedTimestamp', new Date().toISOString());
channelMap.put('webhookPayload', JSON.stringify(webhookPayload));

logger.info('WEBHOOK_RECEIVER: Received webhook from ' + vendor +
    ' (ID: ' + webhookId + ', Signature: ' + signatureStatus + ')');
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>

        <!-- Step 2: Classify and route webhook event -->
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
          <name>Classify Webhook Event</name>
          <sequenceNumber>1</sequenceNumber>
          <enabled>true</enabled>
          <script>
// =============================================================================
// Webhook Event Classification
// =============================================================================
// Classifies the incoming webhook event by category and type for
// proper routing within the IHEP platform.
// =============================================================================

var webhookPayload = JSON.parse(channelMap.get('webhookPayload'));

// Extract event type from various webhook payload formats
var eventType = webhookPayload.event_type ||
    webhookPayload.eventType ||
    webhookPayload.event ||
    webhookPayload.type ||
    (webhookPayload.notification &amp;&amp; webhookPayload.notification.type) ||
    'unknown';

// Extract resource type if present (SMART on FHIR format)
var resourceType = webhookPayload.resource_type ||
    webhookPayload.resourceType ||
    (webhookPayload.focus &amp;&amp; webhookPayload.focus[0] &amp;&amp;
     webhookPayload.focus[0].reference &amp;&amp;
     webhookPayload.focus[0].reference.split('/')[0]) ||
    '';

// Classify event into categories
var eventCategory = 'other';
var eventTypeLower = eventType.toLowerCase();

if (eventTypeLower.indexOf('adt') !== -1 ||
    eventTypeLower.indexOf('admit') !== -1 ||
    eventTypeLower.indexOf('discharge') !== -1 ||
    eventTypeLower.indexOf('transfer') !== -1 ||
    eventTypeLower.indexOf('registration') !== -1 ||
    resourceType === 'Patient' || resourceType === 'Encounter') {
    eventCategory = 'adt';
} else if (eventTypeLower.indexOf('oru') !== -1 ||
           eventTypeLower.indexOf('result') !== -1 ||
           eventTypeLower.indexOf('observation') !== -1 ||
           eventTypeLower.indexOf('lab') !== -1 ||
           eventTypeLower.indexOf('diagnostic') !== -1 ||
           resourceType === 'Observation' || resourceType === 'DiagnosticReport') {
    eventCategory = 'clinical';
} else if (eventTypeLower.indexOf('siu') !== -1 ||
           eventTypeLower.indexOf('schedule') !== -1 ||
           eventTypeLower.indexOf('appointment') !== -1 ||
           eventTypeLower.indexOf('booking') !== -1 ||
           resourceType === 'Appointment') {
    eventCategory = 'scheduling';
} else if (eventTypeLower.indexOf('careplan') !== -1 ||
           eventTypeLower.indexOf('care-plan') !== -1 ||
           eventTypeLower.indexOf('goal') !== -1 ||
           resourceType === 'CarePlan') {
    eventCategory = 'care_management';
} else if (eventTypeLower.indexOf('medication') !== -1 ||
           eventTypeLower.indexOf('prescription') !== -1 ||
           resourceType === 'MedicationRequest') {
    eventCategory = 'medication';
}

// Build IHEP webhook envelope
var ihepWebhookEnvelope = {
    ihep_version: '1.0',
    source: 'webhook',
    vendor: channelMap.get('webhookVendor'),
    event_type: eventType,
    event_category: eventCategory,
    resource_type: resourceType,
    webhook_id: channelMap.get('webhookId'),
    delivery_id: channelMap.get('deliveryId'),
    signature: channelMap.get('webhookSignature'),
    signature_status: channelMap.get('signatureStatus'),
    received_at: channelMap.get('receivedTimestamp'),
    payload: webhookPayload
};

channelMap.put('eventType', eventType);
channelMap.put('eventCategory', eventCategory);
channelMap.put('resourceType', resourceType);
channelMap.put('ihepWebhookEnvelope', JSON.stringify(ihepWebhookEnvelope));

logger.info('WEBHOOK_RECEIVER: Classified event as ' + eventCategory +
    ' (' + eventType + ') for resource ' + resourceType);
          </script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundDataType>RAW</inboundDataType>
      <outboundDataType>RAW</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
    </transformer>
    <filter version="4.5.0">
      <elements>
        <com.mirth.connect.plugins.javascriptrule.JavaScriptRule version="4.5.0">
          <name>Filter Invalid Webhooks</name>
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>
// Pass through all webhooks that were successfully parsed
return channelMap.get('ihepWebhookEnvelope') != null;
          </script>
        </com.mirth.connect.plugins.javascriptrule.JavaScriptRule>
      </elements>
    </filter>
  </sourceConnector>

  <destinationConnectors>
    <!-- Destination 1: Forward to IHEP Integration Gateway Webhook Endpoint -->
    <connector version="4.5.0">
      <metaDataId>1</metaDataId>
      <name>IHEP Webhook Handler</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>5000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>5</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>5</threadCount>
          <threadAssignmentVariable/>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>2000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/webhooks</host>
        <useProxyServer>false</useProxyServer>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
          <entry>
            <string>X-IHEP-Source</string>
            <string>mirth-connect</string>
          </entry>
          <entry>
            <string>X-IHEP-Vendor</string>
            <string>${webhookVendor}</string>
          </entry>
          <entry>
            <string>X-IHEP-Channel</string>
            <string>IHEP_Webhook_Receiver</string>
          </entry>
          <entry>
            <string>X-IHEP-Event-Type</string>
            <string>${eventType}</string>
          </entry>
          <entry>
            <string>X-IHEP-Event-Category</string>
            <string>${eventCategory}</string>
          </entry>
          <entry>
            <string>X-IHEP-Webhook-ID</string>
            <string>${webhookId}</string>
          </entry>
          <entry>
            <string>X-IHEP-Webhook-Signature</string>
            <string>${webhookSignature}</string>
          </entry>
          <entry>
            <string>X-IHEP-Timestamp</string>
            <string>${receivedTimestamp}</string>
          </entry>
        </headers>
        <parameters class="linked-hash-map"/>
        <useHeadersVariable>false</useHeadersVariable>
        <useParametersVariable>false</useParametersVariable>
        <responseXmlBody>false</responseXmlBody>
        <responseParseMultipart>true</responseParseMultipart>
        <responseIncludeMetadata>false</responseIncludeMetadata>
        <multipart>false</multipart>
        <socketTimeout>30000</socketTimeout>
        <connectTimeout>10000</connectTimeout>
        <charset>UTF-8</charset>
        <content>${ihepWebhookEnvelope}</content>
        <contentType>application/json</contentType>
        <dataTypeBinary>false</dataTypeBinary>
        <authentication>false</authentication>
      </properties>
      <transformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </transformer>
      <responseTransformer version="4.5.0">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.0">
            <name>Process Gateway Response</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>
var statusCode = $('responseStatusLine');
logger.info('WEBHOOK_RECEIVER: Gateway responded with status ' + statusCode);
if (statusCode &amp;&amp; statusCode.indexOf('200') === -1 &amp;&amp; statusCode.indexOf('201') === -1) {
    logger.warn('WEBHOOK_RECEIVER: Non-success response: ' + $('responsePayload'));
}
            </script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </responseTransformer>
      <filter version="4.5.0">
        <elements/>
      </filter>
      <waitForPrevious>true</waitForPrevious>
    </connector>

    <!-- Destination 2: Audit Log -->
    <connector version="4.5.0">
      <metaDataId>2</metaDataId>
      <name>Audit Logger</name>
      <properties class="com.mirth.connect.connectors.http.HttpDispatcherProperties" version="4.5.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.0">
          <queueEnabled>true</queueEnabled>
          <sendFirst>true</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>2</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>2</threadCount>
          <threadAssignmentVariable/>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>false</reattachAttachments>
        </destinationConnectorProperties>
        <host>http://ehr-integration-service:8093/api/v1/ehr/audit</host>
        <useProxyServer>false</useProxyServer>
        <method>POST</method>
        <headers class="linked-hash-map">
          <entry>
            <string>Content-Type</string>
            <string>application/json</string>
          </entry>
        </headers>
        <parameters class="linked-hash-map"/>
        <useHeadersVariable>false</useHeadersVariable>
        <useParametersVariable>false</useParametersVariable>
        <responseXmlBody>false</responseXmlBody>
        <responseParseMultipart>false</responseParseMultipart>
        <responseIncludeMetadata>false</responseIncludeMetadata>
        <multipart>false</multipart>
        <socketTimeout>15000</socketTimeout>
        <connectTimeout>5000</connectTimeout>
        <charset>UTF-8</charset>
        <content>{
  "event": "webhook_received",
  "vendor": "${webhookVendor}",
  "channel": "IHEP_Webhook_Receiver",
  "eventType": "${eventType}",
  "eventCategory": "${eventCategory}",
  "resourceType": "${resourceType}",
  "webhookId": "${webhookId}",
  "signatureStatus": "${signatureStatus}",
  "timestamp": "${receivedTimestamp}"
}</content>
        <contentType>application/json</contentType>
        <dataTypeBinary>false</dataTypeBinary>
        <authentication>false</authentication>
      </properties>
      <transformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </transformer>
      <responseTransformer version="4.5.0">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties"/>
      </responseTransformer>
      <filter version="4.5.0">
        <elements/>
      </filter>
      <waitForPrevious>false</waitForPrevious>
    </connector>
  </destinationConnectors>

  <preprocessingScript>// Webhook Receiver Preprocessing
// Respond quickly to prevent webhook timeout retries
logger.debug('WEBHOOK_RECEIVER: Webhook received, length: ' + message.length);
return message;</preprocessingScript>

  <postprocessingScript>// Webhook Receiver Postprocessing
logger.info('WEBHOOK_RECEIVER: Webhook processing complete - ' +
    channelMap.get('eventCategory') + '/' + channelMap.get('eventType') +
    ' from ' + channelMap.get('webhookVendor'));
return;</postprocessingScript>

  <deployScript>// Webhook Receiver Deploy Script
logger.info('IHEP Webhook Receiver channel deployed successfully');
logger.info('Listening on /webhooks/ehr for real-time EHR event notifications');
return;</deployScript>

  <undeployScript>// Webhook Receiver Undeploy Script
logger.info('IHEP Webhook Receiver channel undeployed');
return;</undeployScript>

  <properties version="4.5.0">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>PRODUCTION</messageStorageMode>
    <encryptData>true</encryptData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>true</storeAttachments>
    <tags>
      <tag>webhook</tag>
      <tag>realtime</tag>
      <tag>inbound</tag>
      <tag>ihep</tag>
    </tags>
    <metaDataColumns/>
    <attachmentProperties version="4.5.0">
      <type>None</type>
      <properties/>
    </attachmentProperties>
    <resourceIds class="linked-hash-map">
      <entry>
        <string>Default Resource</string>
        <string>[Default Resource]</string>
      </entry>
    </resourceIds>
  </properties>
</channel>
